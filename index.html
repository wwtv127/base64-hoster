<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent HTML Hoster</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
             // Robustly attempt to parse the environment variable
             firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
             console.log("Firebase config parsed successfully.");
        } catch (e) {
             console.error("Error parsing __firebase_config. The variable may be malformed or missing:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Set Firebase logging for debugging
        setLogLevel('Debug');

        let db;
        let auth;
        let userId = null;

        const uploadButton = document.getElementById('upload-button');

        // Function to initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                // AGGRESSIVE CONFIG CHECK: If config is missing critical data, fail early and inform user.
                if (!Object.keys(firebaseConfig).length || !firebaseConfig.projectId) {
                    throw new Error("Firebase configuration object is empty or missing 'projectId'. Cannot connect to the database. This is an environment configuration issue.");
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // Enable the button once initialized and authenticated
                uploadButton.disabled = false;
                uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                uploadButton.textContent = 'Upload & Generate Permanent Link';

                console.log("Firebase initialized. User ID:", userId);

                // Once authenticated, check URL parameters for content ID
                checkAndRoute();

            } catch (error) {
                console.error("Firebase Initialization or Authentication failed:", error);
                
                // Show the error message banner
                const errorMessageElement = document.getElementById('error-message');
                errorMessageElement.classList.remove('hidden');
                errorMessageElement.textContent = `Initialization failed. Error: ${error.message}`;
            }
        }

        // --- Utility Functions ---

        /** Shows a temporary message in the message box. */
        function showMessage(text, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-900', 'bg-yellow-900', 'text-red-300', 'text-yellow-300', 'bg-green-900', 'text-green-300');
            if (type === 'error') {
                messageBox.classList.add('bg-red-900', 'text-red-300');
            } else if (type === 'success') {
                 messageBox.classList.add('bg-green-900', 'text-green-300');
            } else { // info
                messageBox.classList.add('bg-yellow-900', 'text-yellow-300');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 7000);
        }

        /** Hides controls and sets up the iframe for full-screen display */
        function enterHostMode() {
            document.getElementById('app-controls').classList.add('hidden');
            const mainContent = document.getElementById('main-content');
            const renderedOutputArea = document.getElementById('rendered-output-area');
            const outputTitle = document.getElementById('output-title');
            const iframeWrapper = document.getElementById('iframe-wrapper');

            document.body.classList.remove('bg-background', 'text-text-light');
            document.body.classList.add('bg-white');

            mainContent.classList.remove('p-4', 'sm:p-8', 'space-y-8', 'min-h-screen');
            mainContent.classList.add('h-screen', 'w-full', 'p-0');

            renderedOutputArea.classList.remove('bg-white', 'p-2', 'rounded-xl', 'shadow-2xl', 'min-h-[400px]');
            renderedOutputArea.classList.add('w-full', 'h-full', 'p-0', 'm-0', 'flex', 'flex-col');
            outputTitle.classList.add('hidden');

            iframeWrapper.classList.remove('border', 'border-gray-300', 'rounded-lg');
            iframeWrapper.classList.add('h-full');
        }

        /** Renders content or an error message into the iframe. */
        function renderContent(htmlContent, isError = false) {
            const iframe = document.getElementById('content-iframe');
            if (isError) {
                iframe.srcdoc = `
                    <div style="padding: 20px; text-align: center; font-family: sans-serif; color: #374151;">
                        <h1 style="color: #ef4444;">${htmlContent.title}</h1>
                        <p style="color: #6b7280;">${htmlContent.message}</p>
                    </div>
                `;
            } else {
                iframe.srcdoc = htmlContent;
            }
        }

        // --- Core Application Logic ---

        /** Uploads the HTML content to Firestore and generates the unique URL. */
        async function uploadAndGenerateLink() {
            if (!db || uploadButton.disabled) {
                showMessage("Database not ready. Please wait for initialization.", 'error');
                return;
            }

            const rawHtmlInput = document.getElementById('raw-html-input');
            const durationInput = document.getElementById('duration-select');
            const rawHtml = rawHtmlInput.value.trim();
            const durationDays = parseInt(durationInput.value, 10);
            
            if (!rawHtml) {
                showMessage("Please enter some HTML content first.", 'error');
                return;
            }

            uploadButton.disabled = true;
            uploadButton.classList.add('opacity-50', 'cursor-not-allowed');
            uploadButton.textContent = 'Uploading...';

            try {
                // 1. Calculate Expiry Date
                const now = new Date();
                // Days to milliseconds
                const expiresAt = new Date(now.getTime() + durationDays * 24 * 60 * 60 * 1000); 

                // 2. Define the public collection path
                // Collection structure: /artifacts/{appId}/public/data/hosted_files
                const collectionPath = `artifacts/${appId}/public/data/hosted_files`;

                // 3. Save the document to Firestore
                const docRef = await addDoc(collection(db, collectionPath), {
                    content: rawHtml,
                    userId: userId, // Record who uploaded it
                    createdAt: now.toISOString(),
                    expiresAt: expiresAt.toISOString(),
                });

                // 4. Construct the full hosting URL using the new document ID
                const baseUrl = window.location.origin + window.location.pathname;
                const hostingUrl = `${baseUrl}?id=${docRef.id}`;

                // 5. Update the UI
                const generatedUrlInput = document.getElementById('generated-url');
                const urlOutputContainer = document.getElementById('url-output-container');

                generatedUrlInput.value = hostingUrl;
                urlOutputContainer.classList.remove('hidden');

                // Auto-copy the URL
                generatedUrlInput.select();
                document.execCommand('copy');
                showMessage(`Link generated and copied! Content expires in ${durationDays} days.`, 'success');

            } catch (e) {
                console.error("Firestore Upload Error:", e);
                showMessage("Failed to upload content. See console for details.", 'error');
            } finally {
                uploadButton.disabled = false;
                uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                uploadButton.textContent = 'Upload & Generate Permanent Link';
            }
        }

        /** Checks the URL for an ID and routes to host mode if found. */
        async function checkAndRoute() {
            const urlParams = new URLSearchParams(window.location.search);
            const docId = urlParams.get('id');
            const outputTitle = document.getElementById('output-title');

            if (docId && db) {
                // Host Mode: Fetch content from Firestore
                enterHostMode();
                outputTitle.textContent = `Loading Content ID: ${docId}`;

                try {
                    // Fetch from public collection
                    const collectionPath = `artifacts/${appId}/public/data/hosted_files`;
                    const docRef = doc(db, collectionPath, docId);
                    const docSnap = await getDoc(docRef);

                    if (!docSnap.exists()) {
                         renderContent({title: "404 Not Found", message: "The requested content ID does not exist."}, true);
                         return;
                    }

                    const data = docSnap.data();
                    const expiresAt = new Date(data.expiresAt);
                    const now = new Date();

                    if (now > expiresAt) {
                        renderContent({title: "Link Expired", message: `This hosted content expired on ${expiresAt.toLocaleDateString()}.`}, true);
                    } else {
                        // Success: Render the actual HTML content
                        renderContent(data.content);
                    }

                } catch (e) {
                    console.error("Firestore Fetch Error:", e);
                    renderContent({title: "Database Error", message: "Could not retrieve content. Check network and console."}, true);
                }

            } else {
                // App Mode: Show controls
                renderContent({title: "Generator Mode", message: "Use the control panel to upload your HTML and generate a shareable link."}, true);
            }
        }

        // --- Initialization and Event Listeners ---

        window.onload = function() {
            // Start Firebase initialization
            initializeFirebase();
            
            const copyUrlButton = document.getElementById('copy-url-button');
            const generatedUrlInput = document.getElementById('generated-url');

            // Attach event listener after the button variable is assigned globally
            if (uploadButton) {
                uploadButton.addEventListener('click', uploadAndGenerateLink);
            }
            if (copyUrlButton) {
                copyUrlButton.addEventListener('click', () => {
                    generatedUrlInput.select();
                    document.execCommand('copy');
                    showMessage("Hosting URL copied to clipboard!", 'success');
                });
            }
        };

    </script>
    <style>
        .text-primary { color: #4f46e5; }
        .bg-background { background-color: #1f2937; }
        .bg-surface { background-color: #374151; }
        .text-text-light { color: #f3f4f6; }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        #main-content {
            min-height: 100vh;
        }
        #content-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }
        #iframe-wrapper {
            height: 100%;
        }
    </style>
</head>
<body class="bg-background text-text-light">
    <!-- Fixed Error Message Area -->
    <div id="error-message" class="fixed top-0 left-0 right-0 p-3 bg-red-900 text-red-100 text-center text-sm font-medium hidden z-50"></div>

    <!-- Main content container -->
    <div id="main-content" class="p-4 sm:p-8 flex flex-col space-y-8">

        <!-- UI Controls Wrapper (Hidden in host mode) -->
        <div id="app-controls">
            <header class="text-center">
                <h1 class="text-4xl font-extrabold text-primary">Firestore HTML Hoster</h1>
                <p class="mt-2 text-surface-light text-lg">Host large HTML files using a database link that expires after a set duration.</p>
            </header>

            <!-- Control Panel -->
            <div class="bg-surface p-6 rounded-xl shadow-2xl space-y-4">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2">Control Panel</h2>

                <!-- Input: Raw HTML for Uploading -->
                <div>
                    <label for="raw-html-input" class="block text-sm font-medium mb-1">1. Enter Raw HTML to Host (No size limit):</label>
                    <textarea id="raw-html-input" rows="5" placeholder="Your full, large HTML code goes here." class="w-full p-3 rounded-lg bg-gray-700 text-text-light border-gray-600 focus:ring-primary focus:border-primary"></textarea>
                </div>
                
                <!-- Duration Selector -->
                <div>
                    <label for="duration-select" class="block text-sm font-medium mb-1">2. Set Hosting Duration:</label>
                    <select id="duration-select" class="w-full p-3 rounded-lg bg-gray-700 text-text-light border-gray-600 focus:ring-primary focus:border-primary">
                        <option value="1">1 Day</option>
                        <option value="3">3 Days</option>
                        <option value="7" selected>7 Days</option>
                        <option value="30">30 Days (1 Month)</option>
                    </select>
                </div>

                <!-- Initial state is disabled to prevent race condition -->
                <button id="upload-button" disabled class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg shadow-green-900/50 opacity-50 cursor-not-allowed">
                    Initializing Database...
                </button>

                <!-- Output: Generated URL -->
                <div id="url-output-container" class="mt-4 hidden">
                    <label for="generated-url" class="block text-sm font-medium mb-1">3. Generated Hosting URL (Click to Copy):</label>
                    <div class="relative">
                        <input type="text" id="generated-url" readonly class="w-full p-3 pr-12 rounded-lg bg-gray-800 text-yellow-300 font-mono text-sm border-gray-600">
                        <button id="copy-url-button" class="absolute inset-y-0 right-0 p-3 text-gray-400 hover:text-white transition" title="Copy URL">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v2" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">Share this URL. It uses the ID to fetch content from the database. **Warning: It may take 1-2 minutes for GitHub Pages to deploy the base page initially.**</p>
                </div>

                <!-- Message Box -->
                <div id="message-box" class="mt-4 text-center p-3 rounded-lg hidden" role="alert"></div>

            </div>
        </div>

        <!-- Rendered Output Area -->
        <div id="rendered-output-area" class="flex-1 bg-white p-2 rounded-xl shadow-2xl flex flex-col overflow-hidden min-h-[400px]">
            <h2 id="output-title" class="text-xl font-semibold text-gray-800 mb-2">Hosted Content Preview:</h2>
            <div id="iframe-wrapper" class="flex-1 border border-gray-300 rounded-lg overflow-hidden">
                <iframe id="content-iframe"></iframe>
            </div>
        </div>
    </div>
</body>
</html>

